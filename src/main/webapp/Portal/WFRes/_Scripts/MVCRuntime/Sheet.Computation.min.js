var _Sheet_Computation_GlobalString={Sheet_Computation_Msg0:"计算规则设置错误："},CompuationFun=[{Name:"",Accept:function(t){return-1==t.indexOf("(")},Compuator:function(t,e,i){var a=t.sheet.getDataFieldValue(e,i);return a?a.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,""):0},Field:function(t){return t},IsFunc:!0},{Name:"SUM",Accept:function(t){return 0==t.toLocaleLowerCase().indexOf("sum(")},Compuator:function(t,e,i,a){var n=this.Field(i);i=this.Express(i);var r=0;return $("input[data-datafield='"+n+"'],span[data-datafield='"+n+"']").each(function(t,e,i){var a=0;a=e?t.executeCompute(this.id,i,e):"input"==this.tagName.toLocaleLowerCase()||"select"==this.tagName.toLocaleLowerCase()?this.value:this.innerText,$(this).attr("data-formatrule")&&(a=a.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"")),a&&!isNaN(a)&&(r+=parseFloat(a))},[t,i,a]),r},Field:function(t){var e=t.substring(t.indexOf("{")+1);return e=e.substring(0,e.indexOf("}")),e},Express:function(t){if(-1==t.indexOf(","))return"";var e=t.substring(t.indexOf(",")+1);return e.substring(0,e.length-1)},IsFunc:!0},{Name:"AVG",Accept:function(t){return 0==t.toLocaleLowerCase().indexOf("avg(")},Compuator:function(t,e,i,a){var n=this.Field(i);i=this.Express(i);var r=0,s=$("input[data-datafield='"+n+"'],span[data-datafield='"+n+"']");return $("input[data-datafield='"+n+"'],span[data-datafield='"+n+"']").each(function(t,e,i){var a=0;a=e?t.executeCompute(this.id,i,e):"input"==this.tagName.toLocaleLowerCase()||"select"==this.tagName.toLocaleLowerCase()?this.value:this.innerText,$(this).attr("data-formatrule")&&(a=a.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"")),a&&!isNaN(a)&&(r+=parseFloat(a))},[t,i,a]),parseFloat(r/s.length)},Field:function(t){var e=t.substring(t.indexOf("{")+1);return e=e.substring(0,e.indexOf("}")),e},Express:function(t){if(-1==t.indexOf(","))return"";var e=t.substring(t.indexOf(",")+1);return e.substring(0,e.length-1)},IsFunc:!0},{Name:"COUNT",Accept:function(t){return 0==t.toLocaleLowerCase().indexOf("count(")},Compuator:function(t,e,i,a){var n=this.Field(i),r=$("input[data-datafield='"+n+"'],span[data-datafield='"+n+"']");return r.length},Field:function(t){var e=t.substring(t.indexOf("{")+1);return e=e.substring(0,e.indexOf("}")),e},Express:function(t){if(-1==t.indexOf(","))return"";var e=t.substring(t.indexOf(",")+1);return e.substring(0,e.length-1)},IsFunc:!0},{Name:"MAX",Accept:function(t){return 0==t.toLocaleLowerCase().indexOf("max(")},Compuator:function(t,e,i,a){var n=this.Field(i);i=this.Express(i);var r=0;return $("input[data-datafield='"+n+"'],span[data-datafield='"+n+"']").each(function(t,e,i){var a=0;if(a=e?t.executeCompute(this.id,i,e):"input"==this.tagName.toLocaleLowerCase()||"select"==this.tagName.toLocaleLowerCase()?this.value:this.innerText,$(this).attr("data-formatrule")&&(a=a.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"")),a&&!isNaN(a)){var n=parseFloat(a);n>r&&(r=n)}},[t,i,a]),r},Field:function(t){var e=t.substring(t.indexOf("{")+1);return e=e.substring(0,e.indexOf("}")),e},Express:function(t){if(-1==t.indexOf(","))return"";var e=t.substring(t.indexOf(",")+1);return e.substring(0,e.length-1)},IsFunc:!0},{Name:"MIN",Accept:function(t){return 0==t.toLocaleLowerCase().indexOf("min(")},Compuator:function(t,e,i,a){var n,r=this.Field(i);return i=this.Express(i),$("input[data-datafield='"+r+"'],span[data-datafield='"+r+"']").each(function(t,e,i){var a=0;if(a=e?t.executeCompute(this.id,i,e):"input"==this.tagName.toLocaleLowerCase()||"select"==this.tagName.toLocaleLowerCase()?this.value:this.innerText,$(this).attr("data-formatrule")&&(a=a.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"")),a&&!isNaN(a)){var r=parseFloat(a);null==n?n=r:r<n&&(n=r)}},[t,i,a]),n},Field:function(t){var e=t.substring(t.indexOf("{")+1);return e=e.substring(0,e.indexOf("}")),e},Express:function(t){if(-1==t.indexOf(","))return"";var e=t.substring(t.indexOf(",")+1);return e.substring(0,e.length-1)},IsFunc:!0}];Sheet.Computation=function(t){this.RegisterEventRules=[],this.RegisterEventOnLoad=[],this.sheet=t,this.operators="+-*/()",this.AttrDataField="data-datafield",this.AttrName="data-computationrule",this.init(this)},Sheet.Computation.prototype={init:function(t){this.RegisterEventRules=[],this.RegisterEventOnLoad=[],this.sheet.container?this.sheet.container=$(this.sheet.container.context).find(":input["+this.AttrName+"],span["+this.AttrName+"],textarea["+this.AttrName+"]"):this.sheet.container=$(":input["+this.AttrName+"],span["+this.AttrName+"],textarea["+this.AttrName+"]"),this.sheet.container.each(function(e){var i,a,n=$.trim($(this).attr(e.AttrName));n&&(1==n.indexOf(",")?(i=t.getRoundFromCompute(n),a=t.getExpressFromCompute(n)):(i=0,a=n),t.registerEvent(t,this.id,i,a,a),this.onkeydown=function(){return!1},this.onpasete=function(){return!1})},[this])},registerEvent:function(t,e,i,a,n){for(var r=a.split("{"),s=[],o=!1,u=1;u<r.length;u++){var l=r[u].indexOf("}");if(-1==l)return void alert(_Sheet_Computation_GlobalString.Sheet_Computation_Msg0+a);for(var d=r[u].substring(0,l),c=0;c<t.RegisterEventRules.length;c++)if(t.RegisterEventRules[c].Express==n&&t.RegisterEventRules[c].ID==e&&t.RegisterEventRules[c].dataField&&0!=t.RegisterEventRules[c].dataField.length)for(var f=0;f<t.RegisterEventRules[c].dataField.length;f++)if(t.RegisterEventRules[c].dataField[f]==d)return;if(!d)return void alert(_Sheet_Computation_GlobalString.Sheet_Computation_Msg0+d);if(s.push(d),o&&2==r.length)break;if(a.indexOf(",")>-1){var g=a.substring(a.indexOf(","));g.indexOf("{")>-1&&g.indexOf("}")>-1&&(g=g.split("{")[1],g=g.substring(0,g.indexOf("}")));var h=$("input["+this.AttrDataField+"='"+d+"'],span["+this.AttrDataField+"='"+d+"'],select["+this.AttrDataField+"='"+d+"'],input["+this.AttrDataField+"='"+g+"'],select["+this.AttrDataField+"='"+g+"']")}else h=$("input["+this.AttrDataField+"='"+d+"'],span["+this.AttrDataField+"='"+d+"'],textarea["+this.AttrDataField+"='"+d+"']");h&&(h.each(function(){t.registerControlEvent(t,e,i,$(this),n)}),t.registerOnLoadEvent(t,e,i,n))}t.RegisterEventRules.push({ID:e,Express:n,dataField:s})},registerControlEvent:function(t,e,i,a,n){var r=a.attr(t.AttrName);if(r){var s=t.getExpressFromCompute(r),o=t.getRoundFromCompute(r);t.registerOnLoadEvent(t,a[0].id,o,s),$("input["+t.AttrName+"='"+r+"']").each(function(){t.registerEvent(t,this.id,o,s,s)}),t.registerEvent(t,e,i,s,n)}else a.change(function(){$("#"+e).length>0&&t.computator(e,i,n)})},registerOnLoadEvent:function(t,e,i,a){for(var n=0;n<t.RegisterEventOnLoad.length;n++)if(t.RegisterEventOnLoad[n]==e)return;$(function(){t.computator(e,i,a)}),t.RegisterEventOnLoad.push(e)},getRoundFromCompute:function(t){return-1==t.indexOf(",")?2:parseInt(t.substring(0,t.indexOf(",")))},getExpressFromCompute:function(t){return-1==t.indexOf(",")?t:t.substring(t.indexOf(",")+1)},executeCompute:function(t,e,i){for(var a="";i.length>0;){var n="",r=i[0];if("{"==r){var s=i.substring(1,i.indexOf("}"));a=a+"("+this.CheckIsDateAndGetDays(CompuationFun[0].Compuator(this,$("#"+t),s,e))+")",i=i.substring(i.indexOf("}")+1)}else if(this.operators.indexOf(r)>-1)i=i.substring(1),a+=r;else if(0==i.toLocaleLowerCase().indexOf("sum")||0==i.toLocaleLowerCase().indexOf("avg")||0==i.toLocaleLowerCase().indexOf("count")||0==i.toLocaleLowerCase().indexOf("min")||0==i.toLocaleLowerCase().indexOf("max")){var o=i.indexOf("("),u=0,l=["("];for(r=o+1;r<i.length;r++)if("("==i[r]&&l.push("("),")"==i[r]&&l.pop(),0==l.length){u=r;break}n=i.substring(0,u+1),i=i.substring(u+1);for(var d=0;d<CompuationFun.length;d++)if(CompuationFun[d].Accept(n)){a+=this.CheckIsDateAndGetDays(CompuationFun[d].Compuator(this,$("#"+t),n,e));break}}else a+=r,i=i.substring(1)}var c=this.sheet.getResultValue(a);return c},computator:function(t,e,i){var a=this.executeCompute(t,e,i);if(isFinite(a)){a=this.toFixed(a,e);var n=$("#"+t);if(n.is("input,textarea")){var r=n.val().replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"");r!=a&&(n.val(a),n.trigger("change"),n.blur())}else if(n.is("div,span")){r=n.html().replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"");r!=a&&(n.html(a),n.trigger("change"),n.blur())}}else if(a&&a.indexOf("$Date")>-1){var s=a.substring(0,a.length-5);if(isFinite(s)){n=$("#"+t);if(n.is("input,textarea")){r=n.val().replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"");r!=s&&(n.val(s),n.trigger("change"),n.blur())}else if(n.is("div,span")){r=n.html().replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"");r!=s&&(n.html(s),n.trigger("change"),n.blur())}}}},toFixed:function(t,e){if(0==t||!t)return t;var i;i=t<0?parseInt(t*Math.pow(10,e)-.5)/Math.pow(10,e):parseInt(t*Math.pow(10,e)+.5)/Math.pow(10,e);var a=i.toString().indexOf(".");if(a<0&&e>0){i+=".";for(var n=0;n<e;n++)i+="0"}else{a=i.toString().length-a;for(n=0;n<e-a+1;n++)i+="0"}return i},CheckIsDateAndGetDays:function(t){return null==String(t).match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/)?t:new Date(t).getTime()/864e5}};